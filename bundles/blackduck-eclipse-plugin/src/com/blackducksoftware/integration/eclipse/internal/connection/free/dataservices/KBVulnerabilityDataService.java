package com.blackducksoftware.integration.eclipse.internal.connection.free.dataservices;

import java.util.ArrayList;
import java.util.List;

import com.blackducksoftware.integration.eclipse.internal.connection.free.KBDetailsRequestService;
import com.blackducksoftware.integration.eclipse.internal.connection.free.KBDetailsResponse;
import com.blackducksoftware.integration.eclipse.internal.connection.free.model.CVEVulnerabilityView;
import com.blackducksoftware.integration.eclipse.internal.connection.free.model.VulnDBVulnerabilityView;
import com.blackducksoftware.integration.exception.IntegrationException;

public class KBVulnerabilityDataService {
	private final KBDetailsRequestService kbDetailsRequestService;

	public KBVulnerabilityDataService(final KBDetailsRequestService kbDetailsRequestService) {
		this.kbDetailsRequestService = kbDetailsRequestService;
	}

	public List<CVEVulnerabilityView> getCVEsFromComponentVersion(final String namespace, final String groupId, final String artifactId, final String version)
			throws IntegrationException {
		final KBDetailsResponse kbDetails = kbDetailsRequestService.getKBDetailsFromComponentVersion(namespace, groupId, artifactId, version);
		final List<CVEVulnerabilityView> cves = new ArrayList<>(kbDetails.cves.values());
		return cves;
	}

	public int getPremiumVulnerabilityCount(final String namespace, final String groupId, final String artifactId, final String version)
			throws IntegrationException {
		final KBDetailsResponse kbDetails = kbDetailsRequestService.getKBDetailsFromComponentVersion(namespace, groupId, artifactId, version);
		final List<VulnDBVulnerabilityView[]> vulns = new ArrayList<>(kbDetails.vulns.values());
		int vulnCount = 0;
		for(final VulnDBVulnerabilityView[] vuln : vulns){
			vulnCount+=vuln.length;
		}
		return vulnCount;
	}
}
